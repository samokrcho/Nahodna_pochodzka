#include "simulation.h"
#include <stdlib.h>

Simulation* create_simulation(int width, int height, int K, int reps){
    Simulation* s = malloc(sizeof(Simulation));
    s->world = create_world(width,height);
    s->walker.x = width/2;
    s->walker.y = height/2;
    s->replikacie = reps;
    s->K = K;

    s->avg_steps = malloc(height*sizeof(double*));
    s->prob_success = malloc(height*sizeof(double*));
    for(int y=0;y<height;y++){
        s->avg_steps[y] = malloc(width*sizeof(double));
        s->prob_success[y] = malloc(width*sizeof(double));
        for(int x=0;x<width;x++){
            s->avg_steps[y][x] = 0;
            s->prob_success[y][x] = 0;
        }
    }
    return s;
}

Simulation* create_simulation_with_obstacles(int width, int height, int K, int reps, double ratio){
    Simulation* s = malloc(sizeof(Simulation));
    s->world = create_world_with_obstacles(width,height,ratio);
    s->walker.x = width/2;
    s->walker.y = height/2;
    s->replikacie = reps;
    s->K = K;

    s->avg_steps = malloc(height*sizeof(double*));
    s->prob_success = malloc(height*sizeof(double*));
    for(int y=0;y<height;y++){
        s->avg_steps[y] = malloc(width*sizeof(double));
        s->prob_success[y] = malloc(width*sizeof(double));
        for(int x=0;x<width;x++){
            s->avg_steps[y][x] = 0;
            s->prob_success[y][x] = 0;
        }
    }
    return s;
}

void destroy_simulation(Simulation* s){
    destroy_world(s->world);
    for(int y=0;y<s->world->height;y++){
        free(s->avg_steps[y]);
        free(s->prob_success[y]);
    }
    free(s->avg_steps);
    free(s->prob_success);
    free(s);
}

void simulation_update_summary(Simulation* s, int x, int y, int step){
    // jednoduchá simulácia pre sumárny mód
    s->avg_steps[y][x] += step;
    s->prob_success[y][x] += 1.0 / s->replikacie;
}

double simulation_get_avg(Simulation* s,int x,int y){
    return s->avg_steps[y][x];
}

double simulation_get_prob(Simulation* s,int x,int y){
    return s->prob_success[y][x];
}

int save_simulation_file(const char* filename, SimulationConfig* cfg, char** world_cells){
    FILE* f = fopen(filename,"wb");
    if(!f) return -1;

    fwrite(cfg,sizeof(SimulationConfig),1,f);

    // uloz svet (cells)
    for(int y=0;y<cfg->height;y++){
        fwrite(world_cells[y],sizeof(char),cfg->width,f);
    }

    fclose(f);
    return 0;
}

// ------------------------
// načítanie simulacie
int load_simulation_file(const char* filename, SimulationConfig* cfg){
    FILE* f = fopen(filename,"rb");
    if(!f) return -1;

    fread(cfg,sizeof(SimulationConfig),1,f);

    // alokacia a nacitanie sveta
    char** cells = malloc(cfg->height * sizeof(char*));
    for(int y=0;y<cfg->height;y++){
        cells[y] = malloc(cfg->width);
        fread(cells[y],sizeof(char),cfg->width,f);
    }

    // svet sa môže priradiť k simulacii alebo použiť na vytvorenie Simulation objektu
    // klient si môže vytvoriť lokálne sim->world z týchto cells
    // napr. sim = create_simulation(...); memcpy(sim->world->cells,cells,...)

    // uvolni pamät po nacitani
    for(int y=0;y<cfg->height;y++) free(cells[y]);
    free(cells);

    fclose(f);
    return 0;
}